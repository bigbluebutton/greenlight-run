# greenlight-run
A simple way to do a standalone deployment of Greenlight for development or production using docker compose.

# Requirements:
The following guide requires that your system has two valid FQDNs (Fully Qualified Domain Names) one for Greenlight and another for Keycloak that we will configure the nginx proxy to expect.
We also expect that both of the FQDNs point to your system public IP address and that the web ports HTTP(TCP 80) and HTTPS(TCP 443) are open for inbound traffic.

# Deployment

### Fetching the scripts

```
git clone https://github.com/bigbluebutton/greenlight-run
cd greenlight-run
```

### Initializing environment variables
Create a new .env file for greenlight based on the dotenv file included.

```
cp data/greenlight/dotenv data/greenlight/.env
```

Most required variables are pre-set by default, the ones that must be set before starting are:
```
DATABASE_URL= # Postgres database URL (DO NOT SET THIS).
SECRET_KEY_BASE= # Greenlight secret key base (DO NOT SET THIS).
```

They can be added by editing the file or with sed.

```
sed -i "s/SECRET_KEY_BASE=.*/SECRET_KEY_BASE=$(openssl rand -hex 64)/" data/greenlight/.env
```

Create a new .env file for the deployment based on the dotenv file included.

```
cp dotenv .env
```

Most required variables are pre-set by default, the ones that must be set before starting are:

```
POSTGRES_PASSWORD= # Postgres user password (DO NOT SET THIS).
KEYCLOAK_PASSWORD= # Keycloak admin password (DO NOT SET THIS).
```

It's recommonded to generate secure random credentials such as the **POSTGRES_PASSWORD** and the **KEYCLOAK_PASSWORD**.
They can be generated by running:
```
psql_pwd="$(openssl rand -hex 40)";kc_pwd="$(openssl rand -hex 40)"
sed -i "s/POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=$psql_pwd/" .env
sed -i "s/KEYCLOAK_PASSWORD=.*/KEYCLOAK_PASSWORD=$kc_pwd/" .env
sed -i "s/DATABASE_URL=.*/DATABASE_URL=postgres:\/\/postgres:$psql_pwd@postgres:5432/" data/greenlight/.env
unset psql_pwd kc_pwd;
```
> Note: Whatever is in **$KEYCLOAK_PASSWORD** will be your Keycloak admin account password.

We also need to set in **.env**:
```
DOMAIN_NAME= # The domain name of the applications, along with a hostname it will form the application FQDN (Fully Qualified Domain Name).
GL_HOSTNAME= # Greenlight hostname, the Greenlight FQDN will be $GL_HOSTNAME.$DOMAIN_NAME.
KC_HOSTNAME= # Keycloak hostname, the Keycloak FQDN will be $KC_HOSTNAME.$DOMAIN_NAME.
```

Example:
If your Greenlight FQDN was **gl.demo.bigbluebutton.org** and Keycloak's was  **kc.demo.bigbluebutton.org**.
You'd go to the **.env** and set:
```
DOMAIN_NAME=demo.bigbluebutton.org
GL_HOSTNAME=gl
KC_HOSTNAME=kc
```

If your Greenlight FQDN was **demo.bigbluebutton.org** and Keycloak's was **kc.demo.bigbluebutton.org**.
You'd go to the **.env** and set:
```
DOMAIN_NAME=bigbluebutton.org
GL_HOSTNAME=demo
KC_HOSTNAME=kc.demo
```
By default, we assume that **GL_HOSTNAME** is **gl** and **KC_HOSTNAME** is **kc** so change that to meet your enviroment.

We'd need to create Keycloak's database, for that kindly run:
```
docker compose up postgres -d && docker exec -it postgres psql -U postgres -c 'CREATE DATABASE keycloakdb;'
```

## Generating SSL certificates signed by Lets encrypt.
Some features on Greenlight and Keycloak will **NOT** work without having a secure HTTPS connection.
To simplify the deployment process because of that requirement we provided a simple automated script `init-letsencrypt.sh` to generate Letsencrypt certificate.
This deployment will also be in charge of handling the renewal of certificates seamlessly.

When using the `init-letsencrypt.sh` script, you should add an email address to be registered when issuing the certificates.
Kindly add your email in **.env**.
```
LETSENCRYPT_EMAIL=
```

Kindly run the script with sufficient priviledges:
```
./init-letsencrypt.sh
```
You will run the script in its interactive mode and therefore you'll be prompted for confirmation of some actions. 
To run the script in a none interactive mode, please run:
```
./init-letsencrypt.sh -n
```
To replace any exisiting certificates, please run:
```
./init-letsencrypt.sh -n -r
```

Congrats on your certificates!

Now start the services.

```
docker compose up -d
```

Now both Greenlight and Keycloak should be accessible through their FQDN via HTTPS!
# Development:

For development, we can use the local template by editing the variable `SITES_TEMPLATE=local` in `.env`. This will redirect the requests to your local rails app instead of doing so to the docker container.

Keep in mind that the port in the template is hard-coded to `3000`, but it can be edited (or sed)  directly at `data/nginx/sites.template-local`.

E.g.
```
sed -i "s/DOMAIN_NAME:.*/DOMAIN_NAME:5000/" data/nginx/sites.template-local
```

When keycloak is initialized, it also needs to be configured by setting those values into the `data/greenlight/.env` file.

The ENV variables that need to be set are:
```
OPENID_CONNECT_CLIENT_ID=
OPENID_CONNECT_CLIENT_SECRET=
OPENID_CONNECT_ISSUER=
OPENID_CONNECT_REDIRECT=
```

For more details please refer to the official documentations https://docs.bigbluebutton.org/greenlight_v3/gl3-install.html.

